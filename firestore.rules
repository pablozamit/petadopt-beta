rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ======= HELPER FUNCTIONS =======
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }
    
    function isShelterVerified(shelterId) {
      let shelterDoc = get(/databases/$(database)/documents/users/$(shelterId));
      return shelterDoc.data.role == 'shelter' && shelterDoc.data.verified == true;
    }
    
    function isConversationParticipant(conversationId) {
      let participants = get(/databases/$(database)/documents/conversations/$(conversationId)).data.participants;
      return request.auth.uid in participants;
    }
    
    function isAdmin() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isProfessional(uid) {
      return get(/databases/$(database)/documents/professionals/$(uid)).data.verified == true;
    }
    
    // ======= USERS COLLECTION =======
    // Contiene: usuarios normales, shelters/refugios, admins
    match /users/{userId} {
      // ✅ Usuario puede leer su propio perfil
      allow read: if isUser(userId);
      
      // ✅ Shelters y profesionales pueden ser leídos públicamente si están verificados
      allow read: if isAuthenticated() && resource.data.verified == true && 
                     (resource.data.role == 'shelter' || resource.data.role == 'admin');
      
      // ✅ Usuario puede actualizar su propio perfil
      allow update: if isUser(userId) && 
                       // No permitir cambiar role
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']);
      
      // ✅ No permitir crear desde Firestore (vienen de Auth)
      allow create: if false;
      
      // ✅ Solo admin puede borrar usuarios
      allow delete: if isAdmin();
    }
    
    // ======= PETS COLLECTION =======
    match /pets/{petId} {
      // ✅ Todos pueden leer mascotas (página de adopción)
      allow read: if isAuthenticated();
      
      // ✅ Solo shelters verificados pueden crear/actualizar/borrar
      allow write: if isAuthenticated() && isShelterVerified(request.auth.uid);
    }
    
    // ======= CONVERSATIONS COLLECTION =======
    // Permite chat entre usuarios y shelters
    match /conversations/{conversationId} {
      // ✅ Solo participantes pueden leer
      allow read: if isAuthenticated() && isConversationParticipant(conversationId);
      
      // ✅ Solo participantes pueden actualizar
      allow update: if isAuthenticated() && isConversationParticipant(conversationId);
      
      // ✅ Crear conversación: ambos usuarios deben existir
      allow create: if isAuthenticated() && 
                       request.resource.data.participants.hasAny([request.auth.uid]) &&
                       request.resource.data.participants.size() == 2;
      
      // ✅ Solo admin puede borrar
      allow delete: if isAdmin();
      
      // ✅ SUBCOLECCIÓN: Mensajes dentro de conversación
      match /messages/{messageId} {
        // ✅ Solo participantes pueden leer mensajes
        allow read: if isAuthenticated() && isConversationParticipant(conversationId);
        
        // ✅ Crear mensaje: solo si eres participante
        allow create: if isAuthenticated() && 
                         isConversationParticipant(conversationId) &&
                         request.resource.data.senderId == request.auth.uid &&
                         request.resource.data.text is string &&
                         request.resource.data.text.size() > 0 &&
                         request.resource.data.senderName is string;
        
        // ✅ Actualizar: solo para marcar como leído
        allow update: if isAuthenticated() && 
                         isConversationParticipant(conversationId) && 
                         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy']);
        
        // ✅ Borrar: solo el remitente en los primeros 30 minutos o admin
        allow delete: if isAdmin() || 
                         (request.auth.uid == resource.data.senderId && 
                          request.time < resource.data.createdAt + duration.value(30, 'm'));
      }
    }
    
    // ======= PROFESSIONALS COLLECTION =======
    // Coleccsión separada para veterinarios, educadores, peluqueros, etc.
    match /professionals/{professionalId} {
      // ✅ Todos pueden leer profesionales verificados
      allow read: if isAuthenticated() && resource.data.verified == true;
      
      // ✅ Profesionales no verificados solo ellos pueden leer
      allow read: if isUser(professionalId);
      
      // ✅ Usuario puede crear su perfil como profesional
      allow create: if isUser(professionalId) && 
                       !request.resource.data.verified && // No puede auto-verificarse
                       request.resource.data.specialization in ['vet', 'trainer', 'groomer', 'pet_shop', 'daycare', 'walker'];
      
      // ✅ Profesional puede actualizar su perfil (excepto verified)
      allow update: if isUser(professionalId) && 
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['verified']);
      
      // ✅ Solo admin puede verificar profesionales
      allow update: if isAdmin();
      
      // ✅ Solo admin puede borrar
      allow delete: if isAdmin();
      
      // ✅ SUBCOLECCIÓN: Reviews de profesionales
      match /reviews/{reviewId} {
        allow read: if true; // Público
        allow create: if isAuthenticated() && 
                         request.resource.data.userId == request.auth.uid &&
                         request.resource.data.rating is number &&
                         request.resource.data.rating >= 1 && request.resource.data.rating <= 5;
        allow delete: if request.auth.uid == resource.data.userId || isAdmin();
      }
    }
    
    // ======= ERROR LOGS COLLECTION =======
    // Solo para admin - logueo de errores
    match /error_logs/{logId} {
      // ✅ Crear logs desde cliente (con limites)
      allow create: if isAuthenticated();
      
      // ✅ Solo admin puede leer/actualizar/borrar
      allow read: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // ======= DEFAULT: DENY ALL =======
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
